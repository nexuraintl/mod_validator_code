trigger:
  branches:
    include:
      - main
      - dev
      - qa
      - feature/*
  paths:
    exclude:
      - README.md
      - .gitignore
      - docs/*

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: validator_variables

steps:
  # Checkout con historial limitado para commits
  - checkout: self
    fetchDepth: 2
    displayName: 'Obtener código fuente'

  # Configurar Python
  - task: UsePythonVersion@0
    displayName: 'Configurar Python 3.11'
    inputs:
      versionSpec: '3.11'
      addToPath: true

  # Instalar dependencias
  - script: |
      python --version
      pip --version
      pip install --upgrade pip
      pip install requests python-dotenv
    displayName: 'Instalar dependencias Python'

  # Ejecutar análisis de código con Gemini
  - script: |
      echo "Iniciando análisis de código..."
      python pipeline_runner.py
    env:
      # Variable del grupo (API Key de Gemini)
      GEMINI_API_KEY: $(GEMINI_API_KEY)
      # Token automático de Azure DevOps
      AZURE_PAT: $(System.AccessToken)
      # Variables del sistema (automáticas)
      SYSTEM_TEAMFOUNDATIONCOLLECTIONURI: $(System.TeamFoundationCollectionUri)
      SYSTEM_TEAMPROJECT: $(System.TeamProject)
      BUILD_REPOSITORY_ID: $(Build.Repository.ID)
      BUILD_SOURCEVERSION: $(Build.SourceVersion)
    displayName: 'Ejecutar analisis IA'
    continueOnError: true  # Continúa incluso si hay errores

  # Publicar resultados como artefacto (opcional)
  - task: PublishBuildArtifacts@1
    displayName: 'Publicar logs del análisis'
    condition: always()
    inputs:
      PathtoPublish: '$(System.DefaultWorkingDirectory)'
      ArtifactName: 'analisis-codigo-logs'
      publishLocation: 'Container'